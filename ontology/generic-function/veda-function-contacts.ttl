@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix v-s: <http://semantic-machines.com/veda/veda-schema/> .
@prefix v-ui: <http://semantic-machines.com/veda/veda-ui/> .
@prefix v-fc: <http://semantic-machines.com/veda/veda-function-create/> .
@prefix v-fs: <http://semantic-machines.com/veda/veda-function-search/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

<http://semantic-machines.com/veda/veda-function-contacts>
  rdf:type owl:Ontology ;
  rdfs:label "Онтология функции контакты"@ru ;
  rdfs:label "Contacts function ontology"@en ;
  v-s:loadPriority 9 ;
.
v-s:ContactsFunction
  rdf:type owl:Class ;
  rdfs:subClassOf v-s:Function ;
  rdfs:label "Функция управления контактами"@ru ;
  rdfs:label "Contacts management function"@en ;
.

v-s:managedOrganization
  rdf:type owl:ObjectProperty ;
  rdfs:label "Организация"@ru ;
  rdfs:label "Organization"@en ;
  rdfs:domain v-s:ContactsFunction ;
  rdfs:range v-s:Organization ;
.

v-s:PSmanagedOrganization
  rdf:type v-ui:ObjectPropertySpecification ;
  rdfs:label "Спецификация свойства v-s:managedOrganization для класса v-s:ContactsFunction"@ru ;
  rdfs:label "v-s:managedOrganization property specification for v-s:ContactsFunction class"@en ;
  v-ui:forClass v-s:ContactsFunction ;
  v-ui:forProperty v-s:managedOrganization ;
  v-ui:minCardinality 0 ;
  v-ui:maxCardinality 1 ;
  v-ui:queryPrefix "('rdf:type' == 'v-s:Organization')"^^xsd:string ;
  v-ui:placeholder "Выберите организацию"@ru ;
  v-ui:placeholder "Choose organization"@en ;
.

v-s:Contacts
  rdf:type v-s:ContactsFunction ;
  rdfs:label "Контакты"@ru ;
  rdfs:label "Contacts"@en ;
  rdfs:comment "Организационная структура"@ru ;
  rdfs:comment "Organization chart"@en ;
  v-ui:hasTemplate v-s:ContactsTemplate ;
.

v-s:ContactsSearch
  rdf:type v-fs:AttributiveSearch ;
  rdfs:label "Поиск"@ru ;
  rdfs:label "Search"@en ;
  v-fs:searchBlank v-s:ContactsSearchRegistryBlank ;
  v-fs:searchBlankTemplate v-s:ContactsSearchBlankTemplate ;
  v-fs:searchResultTemplate v-s:ContactsSearchResultTemplate ;
  v-fs:sortOrder "'rdfs:label' asc";
.

v-s:ContactsSearchRegistryBlank
  a v-fc:Blank ;
  rdfs:label "Бланк поиска контактов"@ru ;
  rdfs:label "Contacts search blank"@en ;
  v-fc:targetType v-s:Person ;
.

v-s:ContactsBundle
  rdf:type v-s:Bundle;
  rdfs:label "Контакты"@ru ;
  rdfs:label "Contacts"@en ;
.

v-s:SearchTextBundle
  rdf:type v-s:Bundle;
  rdfs:label "Фамилия, должность, телефон, email"@ru ;
  rdfs:label "Name, position, phone, email"@en ;
.

v-s:FastInputBundle
  rdf:type v-s:Bundle;
  rdfs:label "Быстрое заполнение"@ru ;
  rdfs:label "Fast input"@en ;
.

v-s:ContactsTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон функции контакты"@ru ;
  rdfs:label "Contacts function template"@en ;
  v-ui:template """
<script>
  var loadIndicator = $("#load-indicator");

  var tabs = $("#box-tabs li[data-type]", template);
  tabs.click(function(e){
    e.preventDefault();
    loadIndicator.show();

    var self = $(this);
    tabs.removeClass("active");
    self.addClass("active");
    individual["activeTab"] = self.data("type");
    $(".tabContainer", template).empty();


    if (individual["activeTab"] == "search") {
      return new veda.IndividualModel("v-s:Contacts")
        .present($(".tabContainer", template), "v-s:ContactsStructureTemplate")
        .then(function(){
          loadIndicator.hide();
        });
    } else  if (individual["activeTab"] == "my"){
      return veda.user.aspect
        .present($(".tabContainer", template), "v-s:FavoriteContactTemplate")
        .then(function(){
          loadIndicator.hide();
        });
    }
    var targetIndidivUri = self.find("a").attr("about");
    var targetIndidiv = new veda.IndividualModel(targetIndidivUri);
  });

  if (!individual["activeTab"]) {
    individual["activeTab"] = "search";
  }
  $("#box-tabs li[data-type='"+individual["activeTab"]+"']", template).click();

  
</script>
<div class="container-fluid sheet">
  <br>
  <ul id="box-tabs" class="nav nav-tabs nav-right" role="tablist">
    <li class="pull-left"><h2 id="currentTab" class="no-margin" about="@" property="rdfs:label"></h2></li>
    <li data-type="my" role="presentation"><a href="#" about="v-ft:MyBundle" property="rdfs:label"></a></li>
    <li data-type="search" role="presentation" class="active"><a href="#" about="v-s:ContactsBundle" property="rdfs:label"></a></li>
  </ul>
  <br>
  <div class="tabContainer"></div>
</div>
"""
.

v-s:FavoriteContactTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон избранных контактов"@ru ;
  rdfs:label "Favorite contacts template"@en ;
  v-ui:template """
<div>
  <table class="table table-hover">
    <thead>
      <th><span class="glyphicon glyphicon-chevron-down"></span></th>
      <th><span about="rdfs:label" property="rdfs:label"></span></th>
      <th><span about="v-s:ContactsBundle" property="rdfs:label"></th>
      <th></th>
      <th></th>
    </thead>
    <tbody about="@" rel="v-s:hasFavoriteContact" data-template="v-s:ContactCardTemplate">
      <script>
        $(".open-structure").remove();
      </script>
    </tbody>
  </table>
</div>
<script>

</script>
"""
.

v-ui:CompactCommunicationMeanTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "CompactCommunicationMeanTemplate"@ru ;
  rdfs:label "CompactCommunicationMeanTemplate"@en ;
  v-ui:template """
<div>
  <strong about="@" rel="v-s:hasCommunicationMeanChannel">
    <span about="@" property="v-s:shortLabel"></span>
  </strong>
  <span class="simple-text" about="@" property="v-s:description"></span>
  <a class="email-link" style="cursor: pointer;"><span about="@" property="v-s:description"></span></a>
</div>
<script>
  //email
  if (individual.hasValue("v-s:hasCommunicationMeanChannel", "d:a1iwni0b54fvcz41vuts08bxqsh")) {
    $(".simple-text", template).remove();
    var mailto = individual["v-s:description"][0];
    $("a.email-link", template).attr("href", "mailto:"+mailto);
  } else {
    $("a.email-link", template).remove();
  }
  
</script>
"""
.
v-s:ContactCardTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон функции контакты"@ru ;
  rdfs:label "Contacts function template"@en ;
  v-ui:template """
<script>
  if (individual.hasValue("rdf:type", "v-s:Appointment")) {
    $("#orgLabel", template).remove();
    $("span.unit-icon", template).remove();
    $("div.logo-image", template).remove();
    return individual.getPropertyChain("v-s:employee", "v-s:hasImage").then(function(image) {
      if (image.length == 0) {
        individual["v-s:employee"][0]["v-s:hasImage"] = [new veda.IndividualModel("v-s:DefaultPhoto")];
      }
      return true;
    });
  } else {
    var icon = "fa fa-lg";
    if (individual.hasValue('rdf:type', 'v-s:Organization')) {
      $("span.unit-icon", template).remove();
    } else if (individual.hasValue('rdf:type', 'v-s:Department' ) || individual.hasValue('rdf:type', 'v-s:OrgGroup')) {
      icon = icon+" fa-folder-o";
      $("span.unit-icon", template).addClass(icon);
      $("div.logo-image", template).remove();
    }
    $("div.unit-image", template).remove();
    $("#appLabel", template).remove();
  };
  
</script>
<tr>
  <td width="80px">
    <div class="unit-image" about="@" rel="v-s:employee">
      <div about="@" rel="v-s:hasImage" style="width:60px; height:80px">
        <div class="img-thumbnail pointer" about="@" data-template="v-ui:ImageTemplate"></div>
      </div>
    </div>
    <div class="logo-image" about="@" rel="v-s:hasImage" style="width:50px; height:50px">
      <div class="img-thumbnail" about="@" data-template="v-ui:ImageTemplate"></div>
    </div>
    <span class="unit-icon"></span>
  </td>
  <td width="320px">
    <div id="orgLabel" about="@" property="rdfs:label"></div>
    <div id="appLabel" style="white-space: nowrap;overflow-x: hidden;text-overflow: ellipsis;width:320px">
      <div about="@" rel="v-s:employee">
        <span about="@" property="v-s:lastName"></span>
        <span about="@" property="v-s:firstName"></span>
        <span about="@" property="v-s:middleName"></span>
      </div>
      <div class="for-trunc" about="@" rel="v-s:occupation" data-template="v-ui:LabelTemplate">
      </div>
      <div class="absenceBlock" about="@" rel="v-s:employee">
        <span about="v-s:AbsenceUntilBundle" property="rdfs:label"></span><span about="@" property="v-s:dateAbsenceTo"></span>
        <div about="@" rel="v-s:delegate">
          <span about="v-s:delegate" property="rdfs:label"></span><span property="rdfs:label"></span>
        </div>
      </div>
    </div>
  </td>
  <td class="hideInStructure">
    <div>
      <span class="fa fa-lg fa-sitemap open-structure pointer margin-sm-h"></span>
      <span about="@" rel="v-s:parentOrganization" data-template="v-ui:LabelTemplate"></span>
    </div>
  </td>
  <td>
    <div class="communication-container">
      <div class="work-phone col-lg-3 col-md-12"></div>
      <div class="email col-lg-6 col-md-12"></div>
      <div class="other-phone col-lg-3 col-md-12"></div>
    </div>
    <!-- <div about="@" rel="v-s:employee">
      <div class="work-phone col-lg-3 col-md-12"></div>
      <div class="email col-lg-6 col-md-12"></div>
      <div class="other-phone col-lg-3 col-md-12"></div>
    </div>
    <div about="@" rel="v-s:hasCommunicationMean" data-template="v-ui:CompactCommunicationMeanTemplate"></div> -->
  </td>
  <td width="60px">
    <div>
      <span class="hidden faviconIcon pointer fa fa-lg fa-star-o"></span>
      <span about="@" class="zoom hidden" style="float:right;" data-template="v-ui:IconModalTemplate"></span>
    </div>
  </td>
</tr>
<script>
  var commMeansPromises;
  if (individual.hasValue("v-s:employee")) {
    var isAppHasComm = individual["v-s:employee"][0].hasValue("v-s:hasCommunicationMean");
    if (isAppHasComm) {
      commMeansPromises = individual["v-s:employee"][0]["v-s:hasCommunicationMean"].map(function(commMean) {
        return commMean.load();
      });
    }
    if (!individual["v-s:employee"][0].hasValue("v-s:dateAbsenceTo")) {
      $(".absenceBlock", template).remove();
    }
    trunc($(".for-trunc .label-template", template));
  } else {
    if (individual.hasValue("v-s:hasCommunicationMean")) {
      commMeansPromises = individual["v-s:hasCommunicationMean"].map(function(commMean) {
        return commMean.load();
      });
    }
  };
  if (commMeansPromises == undefined) {
    $(".communication-container", template).remove();
  } else {
    var faviconIcon = $("span.faviconIcon", template);
    faviconIcon.removeClass("hidden");
    var contactHolder = faviconIcon.closest("tr").attr("resource");
    if (veda.user.aspect.hasValue("v-s:hasFavoriteContact", contactHolder)) {
      faviconIcon.toggleClass("fa-star-o fa-star");
    };

    faviconIcon.click(function(){
      if (faviconIcon.hasClass("fa-star-o")) {
        veda.user.aspect.addValue("v-s:hasFavoriteContact", new veda.IndividualModel(contactHolder));
      } else if (faviconIcon.hasClass("fa-star")) {
        veda.user.aspect.removeValue("v-s:hasFavoriteContact", new veda.IndividualModel(contactHolder));
      };
      veda.user.aspect.save();
      faviconIcon.toggleClass("fa-star-o fa-star");
    });

    return Promise.all(commMeansPromises).then(function(commMeans) {
      commMeans.forEach(function(commMean) {
        if (commMean.hasValue("v-s:hasCommunicationMeanChannel", "d:o3q2gagyvfwh430io88vvb8vel")) {
          $(".work-phone", template).append("<span>" + commMean["v-s:description"][0] + "</span>");
        } else if (commMean.hasValue("v-s:hasCommunicationMeanChannel", "d:a1iwni0b54fvcz41vuts08bxqsh")) {
          var aDiv = $("<div><a class='email-link' style='cursor: pointer;'></a></div>");
          $("a", aDiv).attr("href", "mailto:" + commMean["v-s:description"][0]).text(commMean["v-s:description"][0]);
          $(".email", template).append(aDiv);
        } else {
          $(".other-phone", template).append("<span>" + commMean["v-s:description"][0] + "</span>");
        }
      })
    })
  };

  function trunc (el) {
    var elTxt = el.text();
    if (elTxt.length > 35) { el.text( elTxt.substr(0, 35) + "..." ); }
  }
</script>
"""
.

v-s:ContactsStructureTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон функции контакты"@ru ;
  rdfs:label "Contacts function template"@en ;
  v-ui:template """
<script>
  return new veda.IndividualModel("v-s:vedaInfo").load().then(function(vedaInfo) {
    if (vedaInfo.hasValue("v-s:tenant") && vedaInfo["v-s:tenant"][0].id != veda.appointment["v-s:parentOrganization"][0].id) {
      individual["v-s:managedOrganization"] = vedaInfo["v-s:tenant"];
      $("#tenant", template).click(function(){
        individual["v-s:managedOrganization"] = vedaInfo["v-s:tenant"];
      });
    } else {
      $("#tenant", template).remove();
    };
    return true;
  }).then(function(){
    if (veda.user && veda.user.hasValue("v-s:parentOrganization")) {
      var selfOrg = veda.user["v-s:parentOrganization"][0];
      return selfOrg.present($("#selfOrg span", template), "v-ui:LabelTemplate");
    } else {
      $("#selfOrg", template).remove();
    }
  });

</script>
<div>
  <style>
    div.value-row > div.item {
      padding: 8px;
      white-space: nowrap;
      overflow-x: hidden;
      text-overflow: clip;
    }
    div.item:hover {
      background-color: #fcf8e3;
    }
    div.warning {
      background-color: #faf2cc;
    }
    #searchText input {
      border-top-left-radius: 4px;
      border-bottom-left-radius: 4px;
    }
    .children {
      border-left: 1px dashed #eee;
      padding-left: 8px;
      margin-left: 14px;
    }
    /*#orgContent {
      background-color: #fff;
    }*/
    #resizeLine {
      position:  absolute;
      float: left;
      width: 3px;
      height: 100%;
      cursor: col-resize;
      background-color: #ddd;

    }
    .result-table thead {
      background-color: #f5f5f5;
    }

    .section-header > span.glyphicon {
      margin-right: 5%; 
    }

    div.result-info-container {
      margin-top: -20px;
    }

  </style>
  <div class="row  margin-md">
    <div class="col-md-3">
      <!-- <veda-control id="searchText" property="*" data-type="string"></veda-control> -->
      <div id="searchText" class="input-group">
        <input type="text" class="form-control"/>
        <div class="input-group-addon btn btn-default clear" tabindex="0">✕</div>  
      </div>
      <div class="margin-sm">
        <button id="searchButton" class="btn btn-primary" type="button" about="v-fs:Find" property="rdfs:label"></button>
        <button id="resetButton" class="btn btn-default" type="button" about="v-s:Reset" property="rdfs:label"></button>
      </div>
    </div>
    <div class="col-md-4">
      <veda-control data-type="link" rel="v-s:managedOrganization" data-template="{@.rdfs:label}, {@.v-s:taxId}" class="fulltext" data-query-prefix="('rdf:type' === 'v-s:Organization')"></veda-control>
      <span class="text-muted padding-md" about="v-s:FastInputBundle" property="rdfs:label"></span>
      <button id="selfOrg" class="btn btn-xs btn-primary margin-sm">
        +<span></span>
      </button>
      <button id="tenant" class="btn btn-xs btn-primary margin-sm">
        <span>+</span>
        <span about="v-s:vedaInfo" rel="v-s:tenant" data-template="v-ui:LabelTemplate"></span>
      </button>
    </div>
    <!-- <div class="col-md-1">
      <div class="checkbox margin-sm">
        <label id="deleted-checkbox">
          <input type="checkbox"/>
          <span about="v-s:deleted" property="rdfs:label"></span>
        </label>
      </div>
    </div> -->
  </div>
  <div class="not-found alert alert-warning hidden">
    <strong about="v-fs:Empty" property="rdfs:label"></strong>
    <span about="v-fs:NothingFound" property="rdfs:label"></span>
  </div>
  <section id="resultOrg" style="display: none">
    <h5 class="section-header">
      <span class="glyphicon glyphicon-chevron-right"></span>
      <label about="v-s:OrganizationsBundle" property="rdfs:label"></label>
      <small class="margin-md-h" style="color:black; font-weight: normal">
        <span about="v-fs:cursor" property="rdfs:label"></span>
        <span class="badge"></span>&nbsp;&nbsp;
        <span about="v-fs:estimated" property="rdfs:label"></span>
        <span class="badge"></span>
      </small>
    </h5>
    <div class="section-content">
      <table class="table result-table">
        <tbody></tbody>
      </table>
      <div class="result-info-container">
        <button class="btn btn-primary more-results" data-search-type="org" about="v-fs:MoreResults" property="rdfs:label"></button>
        <button class="btn btn-warning all-results" data-search-type="org" about="v-fs:AllResults" property="rdfs:label"></button>
        <small class="margin-sm-h" style="color:black">
          <span about="v-fs:cursor" property="rdfs:label"></span>
          <span class="badge"></span>&nbsp;&nbsp;
          <span about="v-fs:estimated" property="rdfs:label"></span>
          <span class="badge"></span>
        </small>
      </div>
    </div>
  </section>
  <section id="resultDep" style="display: none">
    <h5 class="section-header">
      <span class="glyphicon glyphicon-chevron-right"></span>
      <label about="v-s:DepartmentsBundle" property="rdfs:label"></label>
      <small class="margin-md-h" style="color:black; font-weight: normal">
        <span about="v-fs:cursor" property="rdfs:label"></span>
        <span class="badge"></span>&nbsp;&nbsp;
        <span about="v-fs:estimated" property="rdfs:label"></span>
        <span class="badge"></span>
      </small>
    </h5>
    <div class="section-content">
      <table class="table result-table">
        <tbody></tbody>
      </table>
      <div class="result-info-container">
        <button class="btn btn-primary more-results" data-search-type="dep" about="v-fs:MoreResults" property="rdfs:label"></button>
        <button class="btn btn-warning all-results" data-search-type="dep" about="v-fs:AllResults" property="rdfs:label"></button>
        <small class="margin-sm-h" style="color:black">
          <span about="v-fs:cursor" property="rdfs:label"></span>
          <span class="badge"></span>&nbsp;&nbsp;
          <span about="v-fs:estimated" property="rdfs:label"></span>
          <span class="badge"></span>
        </small>
      </div>
    </div>
  </section>
  <section id="resultApp" style="display: none">
    <h5 class="section-header">
      <span class="glyphicon glyphicon-chevron-down"></span>
      <label about="v-s:AppointmentsBundle" property="rdfs:label"></label>
      <small class="margin-md-h" style="color:black; font-weight: normal">
        <span about="v-fs:cursor" property="rdfs:label"></span>
        <span class="badge"></span>&nbsp;&nbsp;
        <span about="v-fs:estimated" property="rdfs:label"></span>
        <span class="badge"></span>
      </small>
    </h5>
    <div class="section-content">
      <table class="table result-table">
        <tbody></tbody>
      </table>
      <div class="result-info-container">
        <button class="btn btn-primary more-results" data-search-type="app" about="v-fs:MoreResults" property="rdfs:label"></button>
        <button class="btn btn-warning all-results" data-search-type="app" about="v-fs:AllResults" property="rdfs:label"></button>
        <small class="margin-sm-h" style="color:black">
          <span about="v-fs:cursor" property="rdfs:label"></span>
          <span class="badge"></span>&nbsp;&nbsp;
          <span about="v-fs:estimated" property="rdfs:label"></span>
          <span class="badge"></span>
        </small>
      </div>
    </div>
  </section>
  <section id="resultPos" style="display: none">
    <h5 class="section-header">
      <span class="glyphicon glyphicon-chevron-right"></span>
      <label about="v-s:PositionsBundle" property="rdfs:label"></label>
      <small class="margin-md-h" style="color:black; font-weight: normal">
        <span about="v-fs:cursor" property="rdfs:label"></span>
        <span class="badge"></span>&nbsp;&nbsp;
        <span about="v-fs:estimated" property="rdfs:label"></span>
        <span class="badge"></span>
      </small>
    </h5>
    <div class="section-content">
      <table class="table result-table">
        <tbody></tbody>
      </table>
      <div class="result-info-container">
        <button class="btn btn-primary more-results" data-search-type="pos" about="v-fs:MoreResults" property="rdfs:label"></button>
        <button class="btn btn-warning all-results" data-search-type="pos" about="v-fs:AllResults" property="rdfs:label"></button>
        <small class="margin-sm-h" style="color:black">
          <span about="v-fs:cursor" property="rdfs:label"></span>
          <span class="badge"></span>&nbsp;&nbsp;
          <span about="v-fs:estimated" property="rdfs:label"></span>
          <span class="badge"></span>
        </small>
      </div>
    </div>
  </section>
  <section id="OrgStructure" style="display: none;">
    <h5 class="section-header">
      <span class="glyphicon glyphicon-chevron-down"></span>
      <label about="v-s:Contacts" property="rdfs:comment"></label>
    </h5>
    <div class="section-content">
      <div id="orgTree" class="col-md-3" style="padding-right:0px">
      </div>
      <div id="orgContent" class="col-md-9" style="padding-left:5px">
        <div id="resizeLine"></div>
        <div>
          <div id="parentContainer" class="warning padding-md">
            <div about="@" property="rdfs:label"></div>
            <div about="@" rel="v-s:hasCommunicationMean">
              <div>
                <strong about="@" rel="v-s:hasCommunicationMeanChannel" data-template="v-ui:LabelTemplate"></strong>
                <span about="@" property="v-s:description"></span>
              </div>
            </div>
          </div>
          <table class="table table-hover">
            <thead>
              <th></th>
              <th><span about="rdfs:label" property="rdfs:label"></span></th>
              <th><span about="v-s:ContactsBundle" property="rdfs:label"></span></th>
              <th></th>
            </thead>
            <tbody></tbody>
          </table>
          <div class="result-info-container margin-md-h">
            <button id="showMoreCards" class="btn btn-primary" about="v-fs:MoreResults" property="rdfs:label"></button>
            <button id="showAllCards" class="btn btn-warning" about="v-fs:AllResults" property="rdfs:label"></button>
            <small class="margin-md-h" style="color:black">
              <span about="v-fs:cursor" property="rdfs:label"></span>
              <span class="badge"></span>&nbsp;&nbsp;
              <span about="v-fs:estimated" property="rdfs:label"></span>
              <span class="badge"></span>
            </small>
          </div>
        </div>
        </div>
    </div>
  </section>
</div>
<script>
  var basePos;
  var baseWidth;
  var baseWidthStructure;
  var maxWidth;
  $("#resizeLine", template).on("mousedown", function(e){
    e.preventDefault();
    basePos = e.clientX;
    baseWidth = orgTree.width();
    baseWidthStructure = orgContent.width()+60;
    maxWidth = orgTree.parent().width();
  });

  template.on("mouseup", function(e){
    e.preventDefault();
    basePos = undefined;
  });


  template.on("mousemove", function(e) {
    if (basePos == undefined) return;
    e.preventDefault();
    var changedWidth = baseWidth + (e.clientX - basePos);
    if (changedWidth < 300) {
      orgTree.css("width", 300);
      orgContent.css("width", maxWidth - 300);

    } else if (changedWidth > 800) {
      orgTree.css("width", 800);
      orgContent.css("width", maxWidth - 800);
    } else {
      orgTree.css("width", changedWidth);
      orgContent.css("width", maxWidth - changedWidth);
    }
  });


  var loadIndicator = $("#load-indicator");
  var findDeleted = false;
  var searchOrgMode = individual.hasValue("v-s:managedOrganization") ? "targetOrg" : "allOrg";
  var isContactManager = false;
  var userDisplayedElements;
  if (veda.user.preferences.hasValue("v-ui:displayedElements")) {
    userDisplayedElements = veda.user.preferences["v-ui:displayedElements"][0];
  } else {
    userDisplayedElements = 10;
  }

  veda.user.isMemberOf("cfg:ContactManagerGroup").then(function(isMember) {
    isContactManager = isMember || veda.appointment.id == "cfg:AdministratorAppointment";
  });

  $("#selfOrg", template).click(function(){
    individual["v-s:managedOrganization"] = veda.user["v-s:parentOrganization"];
  });

  $("section .section-header", template).click(function(){
    var self = $(this);
    $("span.glyphicon", self).toggleClass("glyphicon-chevron-right glyphicon-chevron-down");
    self.siblings().toggle();
  });

  template.on("click", ".img-thumbnail", function(e){
    e.preventDefault();
    var uri = $(this).attr("resource");
    var modal = veda.Util.showSmallModal(new veda.IndividualModel(uri), "v-ui:ImageTemplate");
    modal.find(".modal-dialog").removeClass("modal-lg").addClass("modal-sm");
  });

  // $("#deleted-checkbox", template).click(function(){
  //   var checkbox = $("#deleted-checkbox input", template);
  //   findDeleted = checkbox.is(':checked');
  // });

  var orgTree = $("#orgTree", template);
  var orgContent = $("#orgContent", template);

  var parentContainerTmpl =
    '<div class="row">'+
      '<div class="col-md-5">'+
        '<div class="margin-sm-h"><strong about="@" property="rdfs:label"></strong></div>'+
        '<div class="margin-sm-h"><small>'+
          '<span about="v-fs:cursor" property="rdfs:label"></span>'+
          '<span class="margin-sm-h badge"></span>&nbsp;&nbsp;'+
          '<span about="v-fs:estimated" property="rdfs:label"></span>'+
          '<span class="margin-sm-h badge"></span>'+
        '</small></div>'+
      '</div>'+
      '<div class="col-md-6" about="@" rel="v-s:hasCommunicationMean">'+
        '<div>'+
          '<strong class="margin-sm-h" about="@" rel="v-s:hasCommunicationMeanChannel" data-template="v-ui:LabelTemplate"></strong>'+
          '<span about="@" property="v-s:description"></span>  '+
        '</div>'+
      '</div>'+
      '<div class="col-md-1">'+
        '<span class="hidden faviconIcon pointer fa fa-lg fa-star-o"></span>'+
        '<span style="float:right" about="@" class="zoom hidden" data-template="v-ui:IconModalTemplate"></span>' +
      '</div>'+
    '</div>';

  function drawCards(parent, from, limit) {
    loadIndicator.show();
    var isNeedBtnMore = false;
    if (limit == undefined) limit = userDisplayedElements;
    if (from == undefined) {
      $("tbody", orgContent).empty();
      orgContent.show();
      from = 0;
    }
    $("#parentContainer", orgContent).empty();

    //parent already has list of all children
    return parent.present($("#parentContainer", orgContent), parentContainerTmpl).then(function(tmpl) {
      if (parent.hasValue("v-s:hasCommunicationMean")) {
        var faviconIcon = $("span.faviconIcon", tmpl);
        faviconIcon.removeClass("hidden");
        if (veda.user.aspect.hasValue("v-s:hasFavoriteContact", parent)) {
          faviconIcon.toggleClass("fa-star-o fa-star");
        };
        faviconIcon.click(function(){
          if (faviconIcon.hasClass("fa-star-o")) {
            veda.user.aspect.addValue("v-s:hasFavoriteContact", parent);
          } else if (faviconIcon.hasClass("fa-star")) {
            veda.user.aspect.removeValue("v-s:hasFavoriteContact", parent);
          };
          veda.user.aspect.save();
          faviconIcon.toggleClass("fa-star-o fa-star");
        });
      }
      if (isContactManager) $(".zoom.hidden", tmpl).removeClass("hidden");
      return getChildren(parent);
    }).then(function(childrenUris){
      var endIndex = childrenUris.length > from + limit ? from + limit : childrenUris.length;
      var promises = [];
      for (var i = from; i < endIndex; i++) {
        var uri = childrenUris[i];
        promises.push(new veda.IndividualModel(uri).present($("<div></div>"), "v-s:ContactCardTemplate"));
      };
      if (endIndex != childrenUris.length) {
        isNeedBtnMore = true;
      };
      if (isNeedBtnMore) {
        $(".result-info-container", orgContent).show();
        $(".result-info-container #showMoreCards", orgContent).off("click");
        $(".result-info-container #showMoreCards", orgContent).click(function(){
          drawCards(parent, from+limit);
        });
        $(".result-info-container #showAllCards", orgContent).off("click");
        $(".result-info-container #showAllCards", orgContent).click(function(){
          drawCards(parent, from+limit, childrenUris.length);
        });
      } else {
        $(".result-info-container", orgContent).hide();
      }
      $("span.badge:nth-child(4)", orgContent).text(childrenUris.length);
      $("span.badge:nth-child(2)", orgContent).text(endIndex);
      if (promises.length == 0) {
        var emptyIndivid = new veda.IndividualModel("v-fs:Empty");
        promises.push(emptyIndivid.present($("<div></div>"), "v-s:ContactCardTemplate"));
      };
      return Promise.all(promises);
    }).then(function(templates) {
      for (var i = 0; i < templates.length; i++){
        $(".hideInStructure", templates[i]).siblings().removeClass("col-md-8");
        $(".hideInStructure", templates[i]).remove();
        $("tbody", orgContent).append(templates[i]);
        if (isContactManager) $(".zoom.hidden", templates[i]).removeClass("hidden");
      }
      $("#resizeLine", template).height(Math.max(orgContent.height(), orgTree.height()));
      loadIndicator.hide();
      return orgContent;
    });
  }

  function initialStructure(org) {
    orgTree.empty();
    orgContent.hide();
    if (org == undefined) {
      org = individual.hasValue('v-s:managedOrganization')? individual['v-s:managedOrganization'][0] : null;
    }
    if ( org ) {
      $("section#OrgStructure").show();
      return getRowTemplate(org).then(function (tmpl) {
        return org.present(orgTree, tmpl);
      }).then(function (rendered) {
        var row = $("#orgTree div.value-row", template);
        return openRow(row).then(function() {
          //drawCards(org);

          return rendered;
        })
      });
    } else {
      $("section#OrgStructure").hide();
      return Promise.resolve(false);
    }
  }

  function getRowTemplate(value) {
    return value.load().then(function (value) {
      var rowTmpl = "<div class='value-row'>" +
                      "<div class='item'>" +
                        "<a href='#' class='expand glyphicon glyphicon-chevron-right'></a>" +
                        "<span style='margin:0 5px;' class='fa fa-lg {icon}'></span>" +
                        "<span about='@' data-template='v-ui:LabelTemplate'></span>" +
                      "</div>" +
                    "</div>";
      var icon = "";
      if ( value.hasValue('rdf:type', 'v-s:Appointment') || value.hasValue('rdf:type', 'v-s:Position') ) {
        return null;
      };
      if ( value.hasValue('rdf:type', 'v-s:Organization') ) {
        icon = 'fa-sitemap';
      }
      if ( value.hasValue('rdf:type', 'v-s:Department' ) || value.hasValue('rdf:type', 'v-s:OrgGroup') ) {
        icon = 'fa-folder-o';
      }
      return rowTmpl.replace("{icon}", icon);
      // else {
      //   return getChildren(value, false).then(function (children) {
      //     if ( value.treeChildrens > 0 ) {
      //       expand = "<a href='#' class='expand glyphicon glyphicon-chevron-right'></a>";
      //     }
      //   });
      // }
      // return rowTmpl.replace("{icon}", icon).replace("{expand}", expand);
    });
  }

  function getChildren(parent, refresh, mode) {
    if (parent.allChildren && !refresh) {
      return Promise.resolve(parent.allChildren);
    }
    var childrenUris = [];
    if (parent.hasValue('rdf:type','v-s:Appointment')) {
      return Promise.resolve([]);
    }
    loadIndicator.show();
    var parentUri = parent.id;

    var selectPart = "SELECT id ";
    var wherePart = "WHERE v_s_parentUnit_str=['" + parentUri + "'] AND v_s_deleted_int=[0]";
    var endingPart = " group by id, rdfs_label_str having sum(sign) > 0 order by arraySort(x -> endsWith(x, '@en'), rdfs_label_str) asc"
    var queryDepartments = selectPart + "FROM veda_tt.`v-s:Department` " + wherePart + endingPart;
    var queryAppointment = selectPart + "FROM veda_tt.`v-s:Appointment` " + "WHERE v_s_parentUnit_str=['" + parentUri + "'] AND v_s_deleted_int=[0] AND v_s_official_int=[1] AND NOT(lowerUTF8(arrayStringConcat(v_s_origin_str, '')) LIKE '%group%')" + endingPart;
    var queryPositions = selectPart + "FROM veda_tt.`v-s:Position` " + "WHERE v_s_parentUnit_str=['" + parentUri + "'] AND v_s_deleted_int=[0] AND lowerUTF8(arrayStringConcat(v_s_origin_str, ' ')) LIKE '%group%'" + endingPart;
    if (mode == "notAppointment") {
      queryAppointment = null;
      queryPositions = null;
    };
    
    var queryStringArray = [];
    if (parent.hasValue('rdf:type', 'v-s:Department')) {
      queryStringArray = [queryDepartments, queryAppointment, queryPositions];
    } else if (parent.hasValue('rdf:type', 'v-s:OrgGroup')) {
      var queryOrgGroup = selectPart + "FROM veda_tt.`v-s:OrgGroup` " + wherePart + endingPart;
      queryStringArray = [queryOrgGroup, queryAppointment, queryPositions];
    } else if (parent.hasValue('rdf:type', 'v-s:Organization')) {
      var queryOrgGroup = selectPart + "FROM veda_tt.`v-s:OrgGroup` " + wherePart + endingPart;
      var querySubsidiary = selectPart + "FROM veda_tt.`v-s:Subsidiary` WHERE v_s_parent_str=['" + parentUri + "'] AND v_s_deleted_int=[0]" + endingPart;
      queryStringArray = [querySubsidiary, queryDepartments, queryOrgGroup, queryAppointment, queryPositions];
    }

    var sort = "'rdfs:label_ru' asc";
    var queries = queryStringArray.map(function (queryString) {
      if (queryString == null) return Promise.resolve({result:[]});
      return veda.Backend.query(
        {
          ticket: veda.ticket, 
          sql: queryString, 
          sort: sort,
          from: 0,
          limit: 10000,
          top: 100
        }
      );
    });
    return Promise.all(queries).then(function (queryResults) {
      parent.treeChildrens = 0;
      queryResults.forEach(function (queryResult, i) {
        //2 last items not counting in childrens (appointments, positions)
        if (i+2 < queryResults.length) parent.treeChildrens+=queryResult.count;
        childrenUris = childrenUris.concat(queryResult.result);
      });
      childrenUris = veda.Util.unique(childrenUris);
      parent.allChildren = childrenUris;
      loadIndicator.hide();
      return childrenUris;
    });
  }

  function drawChildren(parentUri, rootElement) {
    var childrenContainer = rootElement.children(".children");
    if (childrenContainer.length) {
      childrenContainer.removeClass("hidden");
      return Promise.resolve(childrenContainer.length);
    } else {
      rootElement.append("<div class='children'></div>");
      loadIndicator.show();
      return getChildren(new veda.IndividualModel(parentUri), true).then(function (childrenUris) {
        var promises = childrenUris.map(function(childUri) {
          var child = new veda.IndividualModel(childUri);
          return getRowTemplate(child).then(function (tmpl) {
            if (tmpl == null) {
              return Promise.resolve();
            }
            return child.present(rootElement.children(".children"), tmpl);
          });
        })
        return Promise.all(promises);
      }).then(function(result) {
        loadIndicator.hide();
        return result.length;
      });
    };
  }

  function openFromStructure(targetUri) {
    var targetToCards;
    var isInRoot = false;
    var targetIndivid = new veda.IndividualModel(targetUri);
    if ($("section#OrgStructure .section-header .glyphicon", template).hasClass("glyphicon-chevron-right")) {
      $("section#OrgStructure .section-header").click();
    };
    return getParentUnitChain(targetIndivid).then(function(chain) {
      var rootOrg;
      if (chain.length == 0) {
        //isInRoot = true;
        rootOrg = targetIndivid;
      } else {
        rootOrg = chain.pop();
        chain.unshift(targetIndivid);
      }
      targetToCards = targetIndivid;
      return initialStructure(rootOrg).then(function(tmpl) {
        return chain.reduceRight(function(pr, cur) {
          return pr.then(function(){
            var row = $("div.value-row[resource='"+cur.id+"']", tmpl);
            return openRow(row);
          });
        }, Promise.resolve());
      });
    }).then(function() {
      var targetRow = $("div.value-row[resource='"+targetUri+"'] > .item", template);
      targetRow.addClass("warning");
      return isInRoot? true : drawCards(new veda.IndividualModel(targetUri));
    }).then(function(){
      var position = orgContent.offset().top;
      if (position > 0) {
        $("html, body").animate({
          scrollTop: position
        });
      };
      individual.targetToCards = targetUri;
    });
  }

  function getParentUnitChain(target, acc) {
    if (acc == undefined) acc = [];
    return target.load().then(function(){
      if (target.hasValue("v-s:parentUnit")) {
        var parentUnit = target["v-s:parentUnit"][0];
        acc.push(parentUnit);
        return getParentUnitChain(parentUnit, acc);
      } else {
        return acc;
      };
    });
  }
  var searchTextBundle = new veda.IndividualModel("v-s:SearchTextBundle").load().then(function(bundle) {
    $("#searchText input", template).attr("placeholder", bundle["rdfs:label"].map(veda.Util.formatValue).join(" "));
  });

  $("#searchButton", template).click(function(){
    var searchText = $("#searchText input", template).val();
    if (!searchText) return;
    searchText = searchText.trim();
    setSearchHelperObjToDefault();
    loadIndicator.show();

    var queryString;
    var resultOrg = $("#resultOrg", template).hide();
    $("tbody", resultOrg).empty();
    var resultDep = $("#resultDep", template).hide();
    $("tbody", resultDep).empty();
    var resultApp = $("#resultApp", template).hide();
    $("tbody", resultApp).empty();
    var resultPos = $("#resultPos", template).hide();
    $("tbody", resultPos).empty();

    var searchPromise = [];    
    var queryStringArr = genQueryStringArray(searchText, findDeleted, searchOrgMode == "targetOrg");
    searchPromise.push(queryStringArr[0] == null ? Promise.resolve([]) : searchAndLoad("org", queryStringArr[0], 0));
    searchPromise.push(searchAndLoad("dep", queryStringArr[1], 0));
    searchPromise.push(searchAndLoad("app", queryStringArr[2], 0));
    searchPromise.push(searchAndLoad("pos", queryStringArr[3], 0));

    //orgTree.empty();
    //orgContent.hide();
    //$("tbody", orgContent).empty();
    
    return Promise.all(searchPromise).then(function (results) {
      var finded = results.reduce(function(acc, cur) {
        return acc + cur.length;
      }, 0);
      if (finded == 0) {
        $(".not-found", template).removeClass("hidden");
      } else {
        $(".not-found", template).addClass("hidden");
      }
      var presentPromises = [];
      var orgObj = results[0];
      var depObj = results[1];
      var appObj = results[2];
      var posObj = results[3];
      if (orgObj.length > 0) resultOrg.show();
      if (depObj.length > 0) resultDep.show();
      if (appObj.length > 0) resultApp.show();
      if (posObj.length > 0) resultPos.show();
      presentPromises.push(presentSearchResult("org", resultOrg, orgObj));
      presentPromises.push(presentSearchResult("dep", resultDep, depObj));
      presentPromises.push(presentSearchResult("app", resultApp, appObj));
      presentPromises.push(presentSearchResult("pos", resultPos, posObj));
      return Promise.all(presentPromises);
    }).then(function(){
      if ($("section#OrgStructure .section-header .glyphicon", template).hasClass("glyphicon-chevron-down")) {
        $("section#OrgStructure .section-header").click();
      };
      console.log("searchHelperObj: ", searchHelperObj);
      loadIndicator.hide();
      return true;
    });
  });
  
  function genQueryStringArray(searchText, findDeleted, findInParentOrg) {
    var selectPart = "SELECT target.id";
    var endingPart = " GROUP BY target.id, target.rdfs_label_str HAVING sum(target.sign) > 0 order by arraySort(x -> endsWith(x, '@en'), target.rdfs_label_str) asc";
    var basicWherePart = findDeleted? " WHERE target.v_s_deleted_int=[1]" : " WHERE target.v_s_deleted_int=[0]";
    if (findInParentOrg) {
      basicWherePart+= " AND target.v_s_parentOrganization_str=['" + individual['v-s:managedOrganization'][0].id + "']"
    }
    var organizationQuery = selectPart + " FROM veda_tt.`v-s:Organization` AS target";
    var departmentQuery = selectPart + " FROM veda_tt.`v-s:Department` AS target";
    var appointmentQuery = selectPart + " FROM veda_tt.`v-s:Appointment` as target INNER JOIN veda_tt.`v-s:Person` as per ON target.v_s_employee_str[1] = per.id";
    var specialPositionQuery = selectPart + " FROM veda_tt.`v-s:Position` AS target";

    var isCommMeanJoinAdded = false;
    // var isPhoneChannelAdded = false;
    // var isEmailChannelAdded = false;
    var queryParts = searchText.split(' ').reduce(function(qParts, sText) {
      sText = sText.toLowerCase();
      var specialWherePart = "";

      var isPhoneSearch = sText.match("^"+String.fromCharCode(92)+"+?["+String.fromCharCode(92)+"d-"+String.fromCharCode(92)+"s]*$") != null;
      var isEmailSearch = sText.match("^.*@{1}") != null;
      if (isPhoneSearch || isEmailSearch) {
        if (!isCommMeanJoinAdded) {
          isCommMeanJoinAdded = true;
          organizationQuery += " INNER JOIN veda_tt.`v-s:CommunicationMean` as cm ON cm.v_s_backwardTarget_str = [target.id]";
          departmentQuery += " INNER JOIN veda_tt.`v-s:CommunicationMean` as cm ON cm.v_s_backwardTarget_str = [target.id]";
          appointmentQuery += " INNER JOIN veda_tt.`v-s:CommunicationMean` as cm ON cm.v_s_backwardTarget_str = [per.id]";
          specialPositionQuery += " INNER JOIN veda_tt.`v-s:CommunicationMean` as cm ON cm.v_s_backwardTarget_str = [target.id]";
          // organizationQuery += " LEFT JOIN veda_tt.`v-s:CommunicationMean` as cm ON cm.v_s_backwardTarget_str = [target.id]";
          // departmentQuery += " LEFT JOIN veda_tt.`v-s:CommunicationMean` as cm ON cm.v_s_backwardTarget_str = [target.id]";
          // appointmentQuery += " LEFT JOIN veda_tt.`v-s:CommunicationMean` as cm ON cm.v_s_backwardTarget_str = [per.id]";
          // specialPositionQuery += " LEFT JOIN veda_tt.`v-s:CommunicationMean` as cm ON cm.v_s_backwardTarget_str = [target.id]";
        };
        // if (isPhoneSearch && !isPhoneChannelAdded) {
        //   basicWherePart += " AND (cm.v_s_hasCommunicationMeanChannel_str[1] in ('d:fpxx0hw2gyea8z1dcjc6mxtlg2','d:zhercrddg5yotsbbzr33cfoqfc','d:o3q2gagyvfwh430io88vvb8vel','d:m4vg7pkvcvke9e6loqtb937jhy'))";
        // } 
        // if (isEmailSearch && !isEmailChannelAdded) {
        //   basicWherePart += " AND cm.v_s_hasCommunicationMeanChannel_str[1] = 'd:a1iwni0b54fvcz41vuts08bxqsh'";
        // }
        qParts = qParts.map(function(part) {
          return part + " AND (lowerUTF8(cm.v_s_description_str[1]) LIKE '%" + sText + "%' OR lowerUTF8(cm.rdfs_comment_str[1]) LIKE '%" + sText + "%')";
        })
      } else {
        qParts[0] += " AND lowerUTF8(arrayStringConcat(arrayConcat(rdfs_label_str,v_s_title_str, v_s_shortLabel_str), ' ')) LIKE '%"+sText+"%'";
        qParts[1] += " AND lowerUTF8(arrayStringConcat(arrayConcat(rdfs_label_str,v_s_title_str, v_s_shortLabel_str), ' ')) LIKE '%"+sText+"%'";
        qParts[2] += " AND lowerUTF8(arrayStringConcat(arrayConcat(target.rdfs_label_str,per.v_s_middleName_str), ' ')) LIKE '%"+sText+"%'";
        qParts[3] += " AND lowerUTF8(arrayStringConcat(arrayConcat(target.rdfs_label_str,target.rdfs_comment_str), ' ')) LIKE '%"+sText+"%'";
      };
      return qParts;
    }, ["", "", "", ""]);
    organizationQuery = findInParentOrg? null : organizationQuery+basicWherePart+queryParts[0] + " AND v_s_hasCommunicationMean_str[1]!=''" + endingPart;
    departmentQuery += basicWherePart + queryParts[1] + endingPart;
    appointmentQuery += basicWherePart + queryParts[2] + " AND target.v_s_official_int=[1] AND NOT(lowerUTF8(arrayStringConcat(target.v_s_origin_str, '')) LIKE '%group%')" + endingPart;
    specialPositionQuery += basicWherePart + queryParts[3] + " AND lowerUTF8(arrayStringConcat(target.v_s_origin_str, ' ')) LIKE '%group%'" + endingPart;
    return [organizationQuery, departmentQuery, appointmentQuery, specialPositionQuery];
  }

  function presentSearchResult(objType, container, items) {
    var promises = items.map(function(item) {
      return item.present($("<div></div>"), "v-s:ContactCardTemplate");
    });
    return Promise.all(promises).then(function(templates){
      templates.forEach(function(tmpl) {
        if (isContactManager) $(".zoom.hidden", tmpl).removeClass("hidden");
        if (individual.hasValue("v-s:managedOrganization")) {
          $(".hideInStructure span[rel='v-s:parentOrganization']", tmpl).remove();
        }
        $("tbody", container).append(tmpl);
      });
      $("span.badge:nth-child(4)", container).text(searchHelperObj[objType].estimated);
      $("span.badge:nth-child(2)", container).text(searchHelperObj[objType].handlered);
      if ($("tbody tr", container).length < searchHelperObj[objType].estimated) {
        $("div.result-info-container", container).removeClass("hidden");
      } else {
        $("div.result-info-container", container).addClass("hidden");
      };
    });
  }

  var searchHelperObj = {};

  function setSearchHelperObjToDefault(){
    searchHelperObj = {
      org:{
        handlered: 0
      },
      dep:{
        handlered: 0
      },
      app:{
        handlered: 0
      },
      phone:{
        handlered: 0
      },
      email:{
        handlered: 0
      },
      pos:{
        handlered: 0
      }
    };
  }

  function searchAndLoad(objType, queryString, from, top){
    var sort;
    if (objType == "app") {
      sort = "'rdfs:label_ru' asc";
    } else {
      sort = "'rdfs:label' asc";
    }
    if (!top) top = userDisplayedElements;
    //TODO если в консоли не появляется то удалить
    if (objType == "phone" || objType == "email") console.log("This is search ", objType);
    var searchObj = {
      ticket: veda.ticket,
      sql: queryString,
      sort: sort,
      from: from,
      top: top,
      limit: 200,
      async: true
    };
    searchHelperObj[objType].query = queryString;
    return veda.Backend.query(searchObj).then(function(searchResult) {
      searchHelperObj[objType].estimated = searchResult.estimated;
      searchHelperObj[objType].handlered = searchHelperObj[objType].handlered + searchResult.count;
      var loadPromises = [];
      loadPromises = searchResult.result.map(function(uri) {
        return new veda.IndividualModel(uri).load();
      });
      return Promise.all(loadPromises);
    }).catch(function(err) {
      console.log(err);
      return [];
    });
  }

  function openRow(row) {
    var uri = row.attr('resource');
    return drawChildren(uri, row).then(function(childrenCount) {
      var chevron = row.children(".item").find("a");
      if (childrenCount == 0) {
        chevron.removeClass("glyphicon-chevron-right glyphicon-chevron-down");
      } else {
        chevron.toggleClass("expanded glyphicon-chevron-right glyphicon-chevron-down");
      }
      $("#resizeLine", template).height(Math.max(orgContent.height(), orgTree.height()));
      return true;
    });
  }

  function initPopover(target) {
    var uri = target.closest("[resource]").attr("resource");
    var tmpl = "<div><a tabindex='0' role='button' class='to-structure' about='@' property='rdfs:label'/></div>";
    return getParentUnitChain(new veda.IndividualModel(uri)).then(function(chain) {
      var presentPromises = chain.map(function(parent) {
        return parent.present($("<div></div>"), tmpl);
      });
      if (presentPromises.length == 0) {
        presentPromises.push(new veda.IndividualModel(uri).present($("<div></div>"), tmpl));
      };
      return Promise.all(presentPromises);
    }).then(function(templates){
      var cntr = templates.reduceRight(function(acc, curTmpl, i){
        curTmpl.css("margin-left", 15*(templates.length-(i+1)));
        return acc.append(curTmpl);
      }, $("<div><span class='close'>&nbsp;&times;</span></div>"));
      return cntr;
    });
  }

  var openedPopover;
  template.on("click", "span.open-structure", function(e) {
    e.stopPropagation();
    e.preventDefault();
    var self = $(this);
    if (self.attr("data-popovered") == "true") {
      openedPopover = undefined;
      self.popover("hide");
      self.attr("data-popovered", false);  
    } else {
      if (openedPopover) {
        openedPopover.popover("hide");
        openedPopover.attr("data-popovered", false);
      }
      if (self.attr("data-popovered") == undefined) {
        initPopover($(this)).then(function(content) {
          self.popover({
            trigger: "manual",
            placement: "auto right",
            html: true,
            content: content,
            container: template
          });
          content.on("click", ".close", function (e) {
            e.stopPropagation();
            openedPopover = undefined
            self.popover("hide");
            self.attr("data-popovered", false);
          });
          openedPopover = self;
          self.popover("show");
          self.attr("data-popovered", true);
        });
      } else {
        openedPopover = self;
        self.popover("show");
        self.attr("data-popovered", true);
      }  
    };
    
    //return openFromStructure(uri);
  })

  template.on("click", "a.to-structure", function(e){
    e.stopPropagation();
    e.preventDefault();
    openedPopover.popover("hide");
    openedPopover.attr("data-popovered", false);
    openedPopover = undefined;
    var uri = $(this).attr("about");
    var section = $(this).closest("section");
    $(".section-header", section).click();
    return openFromStructure(uri);
  });

  template.on("click", "a.expand.glyphicon-chevron-right", function (e) {
    e.stopPropagation();
    e.preventDefault();
    var row = $(this).closest('div.value-row');
    return openRow(row);
  });

  template.on("click", "a.expanded.glyphicon-chevron-down", function (e) {
    e.stopPropagation();
    e.preventDefault();
    var self = $(this);
    self.toggleClass("expanded glyphicon-chevron-right glyphicon-chevron-down");
    var row = self.closest("div.value-row");
    row.children("div.children").addClass("hidden");
    return false;
  });

  template.on("click", "div.value-row", function (e) {
    e.stopPropagation();
    e.preventDefault();
    var self = $(this);

    var item = self.children('.item');
    if (!item.hasClass('warning')) {
      $('.item.warning', template).removeClass('warning');
      item.addClass('warning');
    }
    var uri = self.attr("resource");
    return drawCards(new veda.IndividualModel(uri));
  });

  template.on("dblclick", "#orgContent tbody tr" , function(e) {
    var uri = $(this).attr("resource");
    if (uri == undefined) {
      console.log("Unexpected behavior: empty attr[resource]");
      return false;
    }
    return  new veda.IndividualModel(uri).load().then(function(loaded) {
      if (!loaded.hasValue("rdf:type", "v-s:Department") && !loaded.hasValue("rdf:type", "v-s:OrgGroup")) {
        return false;
      }
      return Promise.resolve().then(function(){
        var rowInTree = $("#orgTree .children:not(.hidden)>div.value-row[resource='"+uri+"']", template);
        if (rowInTree.length == 0) {
          var parent = $("#orgTree div.item.warning", template).parent();
          return openRow(parent).then(function(){
            return $("div.value-row[resource='"+uri+"']", parent);
          });
        }
        return rowInTree;
      }).then(function(row) {
        row.click();
        return true;
      })
    })
  });

  template.on("click", ".result-info-container .more-results", function (e) {
    var self = $(this);
    var type = self.data("search-type");
    var query = searchHelperObj[type].query;
    var from = searchHelperObj[type].handlered;
    return searchAndLoad(type, query, from).then(function(result) {
      var container = self.closest("section");
      return presentSearchResult(type, container, result);
    });
  });

  template.on("click", ".result-info-container .all-results", function (e) {
    var self = $(this);
    var type = self.data("search-type");
    var query = searchHelperObj[type].query;
    var from = searchHelperObj[type].handlered;
    return searchAndLoad(type, query, from, 200).then(function(result) {
      var container = self.closest("section");
      return presentSearchResult(type, container, result);
    });
  });

  template.on("click", "a.glyphicon-zoom-in", function (e) {
    e.stopPropagation();
    e.preventDefault();
    var self = $(this);
    var uri = self.closest("[resource]").attr("resource");
    var obj = new veda.IndividualModel(uri);
    var tmpl;
    if (obj.hasValue("rdf:type", "v-s:Appointment")) {
      obj = obj["v-s:employee"][0];
      tmpl = undefined;
    } else if (obj.hasValue("rdf:type", "v-s:Department")) {
      tmpl = "v-s:DepartmentTemplate";
    } else if (obj.hasValue("rdf:type", "v-s:Organization")) {
      tmpl = undefined;
    }
    //riot.route( ["#", obj.id, "#main", tmpl].join("/") );
    veda.Util.showModal(obj, tmpl);
    return false;
  });

  // Ctrl + Enter triggers search
  function ctrlEnterHandler (e) {
    // if (e.ctrlKey && e.keyCode === 13) {
    //   $("#searchButton", template).click();
    // }
    if (e.keyCode === 13) {
      $("#searchButton", template).click();
    }
  }
  $(window).on("keyup", ctrlEnterHandler);
  template.one("remove", function () {
    $(window).off("keyup", ctrlEnterHandler);
  });

  function dropResultTables() {
    var resultOrg = $("#resultOrg", template).hide();
    $("tbody", resultOrg).empty();
    var resultDep = $("#resultDep", template).hide();
    $("tbody", resultDep).empty();
    var resultApp = $("#resultApp", template).hide();
    $("tbody", resultApp).empty();
    var resultPos = $("#resultPos", template).hide();
    $("tbody", resultPos).empty();
  }

  individual.on("v-s:managedOrganization", function(){
    searchOrgMode = individual.hasValue("v-s:managedOrganization")? "targetOrg" : "allOrg";
    dropResultTables();

    var searchText = $('#searchText input', template).val();
    if (searchText != '') {
      $("#searchButton", template).click();
    }
    initialStructure().then(function(result) {
      if (result == false) return;
      if ($("section#OrgStructure .section-header .glyphicon", template).hasClass("glyphicon-chevron-right")) {
        $("section#OrgStructure .section-header", template).click();
      };
      return drawCards(individual["v-s:managedOrganization"][0]);
    });
  });

  $("#searchText .clear", template).click(function(){
    $("#searchText input", template).val("");
    dropResultTables();
  });

  $("#resetButton", template).click(function () {
    $("#searchText input", template).val("");
    dropResultTables();
    individual["v-s:managedOrganization"] = [];
  });

  if (individual.targetToCards) {
    return openFromStructure(individual.targetToCards);
  } else {
    return initialStructure().then(function(result) {
      if (result == false) return;
      return drawCards(individual["v-s:managedOrganization"][0]);
    });
  }

  template.one("remove", function(){
    individual.off("v-s:managedOrganization");
  });

</script>
"""
.

v-s:ContactsSearchResultTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон отображения результатов поиска для контактов"@ru ;
  rdfs:label "Contacts search result template"@en ;
  v-ui:template """
<table class="table table-condensed table-striped">
  <thead class="result-header">
    <tr>
      <th width="1%">#</th>
      <th width="1%"><span class="glyphicon glyphicon-search"></span></th>
      <th class="orderby" data-orderby="v-s:lastName"><span about="v-s:lastName" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="v-s:firstName"><span about="v-s:firstName" property="rdfs:label"></span></th>
      <th class="orderby" data-orderby="v-s:middleName"><span about="v-s:middleName" property="rdfs:label"></span></th>
      <th><span about="v-s:occupation" property="rdfs:label"></span></th>
    </tr>
  </thead>
  <tbody class="result-container">
    <tr>
      <td class="serial-number"></td>
      <td about="@" data-template="v-ui:IconModalTemplate"></td>
      <td about="@" property="v-s:lastName"></td>
      <td about="@" property="v-s:firstName"></td>
      <td about="@" property="v-s:middleName"></td>
      <td about="@" rel="v-s:defaultAppointment"><span rel="v-s:occupation" data-template="v-ui:LabelTemplate"></span></td>
    </tr>
  </tbody>
</table>
  """ ;
.

v-s:OrganizationUnitTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон отображения единицы организационной структуры"@ru ;
  rdfs:label "Organization unit template"@en ;
  v-ui:forClass v-s:OrganizationUnit ;
  v-ui:template """
<div class="container sheet">
  <h3><span about="@" property="rdfs:label"></span></h3>
  <span about="@" data-template="v-ui:RabbitHole" data-properties="v-s:parentUnit"></span>
  <hr>
  <div>
    <div class="-view edit search">
      <em about="rdfs:label" property="rdfs:label"></em>
      <div property="rdfs:label" class="view -edit -search"></div>
      <veda-control data-type="string" property="rdfs:label" class="-view edit search"></veda-control>
      <hr class="view -edit -search">
    </div>
    <em about="v-s:parentUnit" property="rdfs:label"></em>
    <div rel="v-s:parentUnit" class="view -edit -search" data-template="v-ui:LabelLinkTemplate"></div>
    <veda-control data-type="link" rel="v-s:parentUnit" class="-view edit search fulltext"></veda-control>
    <div class="row">
      <div class="col-sm-6">
        <em about="v-s:hasChief" property="rdfs:label"></em>
        <div rel="v-s:hasChief" class="view -edit search" data-template="v-ui:LabelTemplate"></div>
        <veda-control data-type="link" rel="v-s:hasChief" class="-view edit search fulltext"></veda-control>
      </div>
      <div class="col-sm-6">
        <em about="v-s:hasFunctionalChief" property="rdfs:label"></em>
        <div rel="v-s:hasFunctionalChief" class="view -edit search" data-template="v-ui:LabelTemplate"></div>
        <veda-control data-type="link" rel="v-s:hasFunctionalChief" class="-view edit search fulltext"></veda-control>
      </div>
    </div>
  </div>
  <br>
  <!-- BUTTONS -->
  <div class="actions">
    <span about="@" data-template="v-ui:StandardButtonsTemplate" data-embedded="true" data-buttons="edit save cancel delete"></span>
  </div>
</div>
  """ ;
.

v-s:OrganizationUnitContentTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон отображения единицы организационной структуры"@ru ;
  rdfs:label "Organization unit template"@en ;
  v-ui:forClass v-s:OrganizationUnit ;
  v-ui:template """
<script>
  var blank = new veda.IndividualModel("v-s:ContactsInUnitSearchRegistryBlank");
  return blank.load().then(function (blank) {
    blank.initBlank().then(function (blankObject) {
      if ( !blankObject.hasValue("v-s:parentUnit", individual) ) {
        blankObject["v-s:parentUnit"] = [ individual ];
        var search = new veda.IndividualModel("v-s:ContactsInUnitSearch");
        return search.load().then(function (search) {
          search["v-fs:searchResult"] = [];
        });
      }
    });
  });

</script>
<div>
  <h4><span about="@" property="rdfs:label"></span></h4>
  <span about="@" data-template="v-ui:RabbitHole" data-properties="v-s:parentUnit"></span>
  <hr>
  <div about="v-s:ContactsInUnitSearch" data-template="v-fs:AttributiveSearchInlineTemplate"></div>
</div>
  """ ;
.

v-s:ContactsInUnitSearch
  rdf:type v-fs:AttributiveSearch ;
  rdfs:label "Поиск"@ru ;
  rdfs:label "Search"@en ;
  v-fs:searchBlank v-s:ContactsInUnitSearchRegistryBlank ;
  v-fs:searchResultTemplate v-s:ContactsInUnitSearchResultTemplate ;
  v-fs:sortOrder "'rdf:type.rdfs:label' desc" ;
  v-fs:searchOnLoad true ;
.

v-s:ContactsInUnitSearchRegistryBlank
  a v-fc:Blank ;
  rdfs:label "Бланк поиска контактов"@ru ;
  rdfs:label "Contacts search blank"@en ;
  v-fc:targetType v-s:Appointment ;
#  v-fc:targetType v-s:Position ;
  v-fc:targetType v-s:Department ;
  v-fc:targetType v-s:OrgGroup ;
.

v-s:ContactsInUnitSearchResultTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон отображения результатов поиска для контактов"@ru ;
  rdfs:label "Contacts search result template"@en ;
  v-ui:template """
<div>
  <div class="result-container">
    <script>
      if ( individual.hasValue("rdf:type", "v-s:Appointment") ) {
        template.children().not(".app").remove();
      } else if ( individual.hasValue("rdf:type", "v-s:Department") || individual.hasValue("rdf:type", "v-s:OrgGroup") ) {
        template.children().not(".dep").remove();
      } else if ( individual.hasValue("rdf:type", "v-s:Organization") ) {
        template.children().not(".org").remove();
      }
    
    </script>
    <div>
      <hr class="app dep org margin-md">
      <span style="width:20px" class="app fa fa-lg fa-user-o"></span>
      <span style="width:20px" class="dep fa fa-lg fa-folder-o"></span>
      <span style="width:20px" class="org fa fa-lg fa-sitemap"></span>
      <strong class="app" about="@" rel="v-s:employee">
        <span property="rdfs:label"></span>
      </strong>
      <span class="app" about="@" rel="v-s:occupation">
        <span property="rdfs:label"></span>
      </span>
      <span class="app" about="@" rel="v-s:employee">
        <span property="v-s:phone"></span>
      </span>
      <span class="app" about="@" rel="v-s:employee">
        <span rel="v-s:hasAccount">
          <a class="view -edit -search" about="@" property="v-s:mailbox"></a>
          <script>
            template.attr("href", "mailto:" + individual["v-s:mailbox"][0]);
          </script>
        </span>
      </span>
      <strong class="dep org" about="@" property="rdfs:label"></strong>
    </div>
  </div>
  <br>
</div>
  """ ;
.

v-s:AppointmentContactTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон отображения контакта персоны"@ru ;
  rdfs:label "Person contact template"@en ;
  v-ui:forClass v-s:Person ;
  v-ui:template """
<div class="horizontal-card horizontal-card-sm">
  <div class="thumbnail" about="@" rel="v-s:hasImage" data-template="v-ui:ImageTemplate"></div>
  <div class="description">
    <div about="@" rel="v-s:employee" class="header">
      <strong><span about="@" property="v-s:firstName"></span> <span about="@" property="v-s:lastName"></span></strong>
    </div>
    <hr class="margin-sm">
    <small rel="v-s:occupation" data-template="v-ui:LabelTemplate"></small>
  </div>
</div>
  """ ;
.
v-s:PositionContactTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон отображения контакта персоны"@ru ;
  rdfs:label "Person contact template"@en ;
  v-ui:forClass v-s:Person ;
  v-ui:template """
<div class="horizontal-card horizontal-card-sm">
  <div class="thumbnail" about="@" rel="v-s:hasImage" data-template="v-ui:ImageTemplate"></div>
  <div class="description">
    <div class="header">
      <strong about="@" property="rdfs:label"></strong>
    </div>
  </div>
</div>
  """ ;
.
v-s:DepartmentContactTemplate
  rdf:type v-ui:ClassTemplate ;
  rdfs:label "Шаблон отображения единицы организационной структуры"@ru ;
  rdfs:label "Organization unit template"@en ;
  v-ui:forClass v-s:Department ;
  v-ui:template """
<div class="horizontal-card horizontal-card-sm">
  <div class="thumbnail">
    <i class="fa fa-folder-open-o fa-2x"></i>
  </div>
  <div class="description">
    <div class="header">
      <strong about="@" property="rdfs:label"></strong>
    </div>
  </div>
</div>
  """ ;
.
