<div>
  <hr class="no-margin">
  <table class="table table-striped table-condensed">
    <thead>
      <tr>
        <th width="1%"><input type="checkbox" class="toggle-select-all"></th>
        <th width="20px">#</th>
        <th width="10px"><span class="glyphicon glyphicon-search"></span></th>
        <th width="15%" data-orderby="v-wf:from.rdfs:label"><span about="v-wf:from" property="rdfs:label"></span></th>
        <th width="15%" data-orderby="v-wf:to.rdfs:label"><span about="v-wf:to" property="rdfs:label"></span></th>
        <th width="30px" class="orderby" data-orderby="v-wf:read"></th>
        <th data-orderby="rdfs:label"><span about="v-s:description" property="rdfs:label"></span></th>
        <th data-orderby="v-wf:onDocument.rdfs:label"><span about="v-ft:DocumentBundle" property="rdfs:label"></span></th>
        <th width="20px"></th>
        <th width="10%" class="orderby" data-orderby="v-s:created"><span about="v-s:created" property="rdfs:label"></span></th>
        <th width="10%" class="orderby" data-orderby="v-wf:dateGiven"><span about="v-wf:dateGiven" property="rdfs:label"></span></th>
      </tr>
    </thead>
    <tbody class="result-container">
      <tr>
        <td width="1%"><input type="checkbox" class="toggle-select"></td>
        <td class="serial-number"></td>
        <td><a href="#/@" class="glyphicon glyphicon-search"></a></td>
        <td>
          <div about="@" rel="v-wf:from" data-template="v-ui_LabelTemplate.html"></div>
          <div about="@" rel="v-wf:redirect_from_task">
            <script>
              if ( !individual.hasValue("v-wf:to") ) {
                template.empty();
              }
            </script>
            <div>
              <hr class="no-margin">
              <strong><small about="v-s:TaskIsRedirectedFrom" property="rdfs:label"></small></strong>
              <small about="@" rel="v-wf:to" data-template="v-ui_LabelTemplate.html"></small>
            </div>
          </div>
        </td>
        <td about="@" rel="v-wf:to" data-template="v-ui_LabelTemplate.html"></td>
        <td>
          <span class="toggle-read glyphicon glyphicon-exclamation-sign"></span>
          <span class="child-task text-muted"></span>
        </td>
        <td>
          <a href="#/@" about="@" property="rdfs:label"></a><br/>
          <i about="@" property="v-s:description"></i>
        </td>
        <td about="@" rel="v-wf:onDocument" data-template="v-ui_ClassNameLabelTemplate.html"></td>
        <td>
          <span class="to-journal pointer text-primary glyphicon glyphicon-list"></span>
        </td>
        <td about="@" property="v-s:created"></td>
        <td about="@" property="v-wf:dateGiven" class="date-given"></td>
      </tr>
      <script>
        // Remove completed tasks from inbox & outbox
        var folder = decodeURIComponent(location.hash).substr(2).split("/")[0];
        var remove = (folder !== "v-ft:Completed");
        removeCompleted.call(this);
        function removeCompleted() {
          if (remove && this.hasValue("v-wf:isCompleted", true)) {
            template.remove();
          }
        }
        individual.on("v-wf:isCompleted", removeCompleted);
        template.one("remove", function () {
          individual.off("v-wf:isCompleted", removeCompleted);
        });

        $(".to-journal", template).click(function(e){
          e.stopPropagation();
          var journalUri = individual["v-wf:onDocument"][0].id + "j";
          riot.route("#/" + journalUri);
        });
        new veda.IndividualModel("v-ft:ToJournalBundle").load().then(function(bundle) {
          $(".to-journal", template).prop("title", bundle.toString());
        });

        // Toggle read/unread
        var toggler = $(".toggle-read", template);
        toggler.prop("title", new veda.IndividualModel("v-ft:ReadUnreadBundle").toString());
        if (folder === "v-ft:Inbox") {
          toggler.addClass("pointer").click(toggleReadClickHandler);
        }
        function toggleReadClickHandler(e) {
          e.stopPropagation();
          var isRead = individual.hasValue("v-wf:read", true);
          toggleRead(!isRead);
          veda.Backend.set_in_individual({
            ticket: veda.ticket,
            individual: {
              "@": individual.id,
              "v-wf:read": [{
                data: !isRead,
                type: "Boolean"
              }]
            },
            async: true
          });
        }
        function readHandler () {
          var isRead = individual.hasValue("v-wf:read", true);
          toggleRead(isRead);
        }
        function toggleRead (isRead) {
          if ( isRead ) {
            template.css("font-weight", "normal");
            toggler.removeClass("text-primary").addClass("text-muted");
          } else {
            template.css("font-weight", "bold");
            toggler.removeClass("text-muted").addClass("text-primary");
          }
        };
        readHandler();
        individual.on("v-wf:read", readHandler);
        template.one("remove", function () {
          individual.off("v-wf:read", readHandler);
        });

        // Child task indicator
        if ( individual.hasValue("v-wf:hasChildTask") ) {
          template.find(".child-task")
            .addClass("glyphicon glyphicon-comment")
            .prop("title", new veda.IndividualModel("v-wf:hasChildTask").toString());
        }

        // Due date indicator
        var dateGivenCell = $(".date-given", template);
        var now = new Date();
        var yesterday = new Date().setHours(0,0,0,1);
        var tomorrow = new Date().setHours(23,59,59,999);
        var dateGiven = individual["v-wf:dateGiven"][0];
        var dateGivenYesterday = new Date(dateGiven).setHours(0,0,0,1);
        var dateGivenTomorrow = new Date(dateGiven).setHours(23,59,59,999);
        var dateDone = individual.hasValue("v-wf:takenDecision") && individual["v-wf:takenDecision"][0]["v-s:created"][0];
        if ( individual.hasValue("v-wf:isCompleted", false) ) {
          if (dateGiven < yesterday) {
            dateGivenCell.toggleClass("bg-danger");
          } else if (yesterday < dateGiven && dateGiven <= tomorrow) {
            dateGivenCell.toggleClass("bg-warning");
          } else if (tomorrow < dateGiven) {
            dateGivenCell.toggleClass("bg-success");
          }
        } else {
          if (dateGivenYesterday < dateDone && dateDone <= dateGivenTomorrow) {
            dateGivenCell.toggleClass("bg-warning");
          } else if (dateDone < dateGiven) {
            dateGivenCell.toggleClass("bg-success");
          } else if (dateGiven < dateDone ) {
            dateGivenCell.toggleClass("bg-danger");
          }
        }
      </script>
    </tbody>
  </table>
</div>